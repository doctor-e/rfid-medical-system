<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Smart RFID Medical System</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- HEADER - ENHANCED -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-heartbeat"></i>
            </div>
            <div class="logo-text">
                <h1>Smart RFID Medical System</h1>
                <p>Patient Safety & Medical Management</p>
            </div>
        </div>
        
        <div class="user-section">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar" style="background: var(--avatar-color);">D</div>
                <div class="user-details">
                    <span class="user-name" id="user-name">Dr. Driss Mansouri</span>
                    <span class="user-role" id="user-role">Physician</span>
                </div>
            </div>
            
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            
            <a href="/emergency-page" class="emergency-btn" id="emergency-btn">
                <i class="fas fa-ambulance"></i> EMERGENCY MODE
            </a>
            
            <button class="back-btn" onclick="backToHome()" id="home-btn" style="display: none;">
                <i class="fas fa-home"></i> Home
            </button>
        </div>
    </header>

    <!-- CUSTOM ALERT - ENHANCED -->
    <div id="custom-alert" class="custom-alert" style="display: none;">
        <div class="alert-icon" id="alert-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="alert-content">
            <div class="alert-title" id="alert-title">Alert Title</div>
            <div class="alert-message" id="alert-message">Alert message goes here</div>
        </div>
        <button class="close-alert" onclick="closeAlert()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="container">
        <!-- RFID SCANNER CARD - ENHANCED -->
        <div id="lookup-section" class="rfid-scanner-card">
            <div class="scanner-header">
                <div class="scanner-icon">
                    <i class="fas fa-id-card"></i>
                </div>
                <h2 class="scanner-title">Patient Identification</h2>
                <p class="scanner-subtitle">Scan RFID card or enter patient ID manually</p>
            </div>
            
            <input type="text" 
                   id="rfid-input" 
                   class="rfid-input-large" 
                   placeholder="SCAN RFID" 
                   autofocus 
                   maxlength="10"
                   autocomplete="off">
            
            <div id="error-display" class="error-message" style="display: none;"></div>
            
            <div class="manual-input">
                <input type="text" 
                       id="manual-input" 
                       placeholder="Or enter Patient ID (e.g., RFID001)"
                       autocomplete="off">
                <button class="load-btn" onclick="loadPatientManual()">
                    <i class="fas fa-search"></i> Load Patient
                </button>
            </div>
            
            <div style="margin-top: 25px; color: #7f8c8d; font-size: 14px; font-weight: 500;">
                <i class="fas fa-info-circle"></i> Valid Patient IDs: RFID001 to RFID050
            </div>
        </div>

        <!-- PATIENT DASHBOARD - ENHANCED -->
        <div id="dashboard-section" class="patient-dashboard" style="display: none;">
            <!-- Patient Header -->
            <div class="patient-header">
                <div class="patient-basic">
                    <div class="patient-avatar" id="patient-avatar" style="background: var(--patient-avatar-color);">A</div>
                    <div class="patient-info">
                        <h2 id="patient-name">Ali Benali</h2>
                        <div class="patient-id">Patient ID: <span id="patient-id">RFID001</span></div>
                    </div>
                </div>
                <button class="back-btn" onclick="backToLookup()">
                    <i class="fas fa-arrow-left"></i> Search Another Patient
                </button>
            </div>

            <!-- Health Score - Enhanced -->
            <div class="health-score">
                <div class="health-score-number" id="health-score">85</div>
                <div class="health-score-label">Overall Health Score</div>
                <div class="health-score-bars" id="health-bars"></div>
            </div>

            <!-- Quick Stats - Enhanced -->
            <div class="grid-3">
                <div class="info-card">
                    <div class="card-title">
                        <i class="fas fa-user"></i> Age & Gender
                    </div>
                    <div class="card-content" id="patient-age-sex">38 years ‚Ä¢ Male</div>
                    <div class="card-subtitle">Date of Birth: <span id="patient-dob">1985-03-12</span></div>
                </div>
                
                <div class="info-card card-critical">
                    <div class="card-title">
                        <i class="fas fa-tint"></i> Blood Type
                    </div>
                    <div class="card-content" id="patient-blood">A+</div>
                    <div class="card-subtitle">Critical for emergencies</div>
                </div>
                
                <div class="info-card card-success">
                    <div class="card-title">
                        <i class="fas fa-calendar-check"></i> Last Visit
                    </div>
                    <div class="card-content" id="last-visit">2026-01-05</div>
                    <div class="card-subtitle" id="last-visit-notes">Routine checkup</div>
                </div>
            </div>

            <!-- PHARMACIST FOCUS: Active Prescriptions - Enhanced -->
            <div class="info-section" id="pharmacist-focus-section">
                <div class="section-title">
                    <i class="fas fa-pills" style="color: #2ecc71;"></i>
                    <h3>Active Prescriptions</h3>
                </div>
                <div id="prescriptions-container">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <!-- Allergies & Diseases - Enhanced -->
            <div class="grid-2">
                <!-- Allergies -->
                <div class="info-section">
                    <div class="section-title">
                        <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                        <h3>Allergies & Sensitivities</h3>
                    </div>
                    <div id="allergies-container">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
                
                <!-- Chronic Diseases -->
                <div class="info-section">
                    <div class="section-title">
                        <i class="fas fa-stethoscope" style="color: #3498db;"></i>
                        <h3>Chronic Conditions</h3>
                    </div>
                    <div id="diseases-container">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons - Enhanced -->
            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="showPrescriptionModal()">
                    <i class="fas fa-file-prescription"></i> Prescription History & Timeline
                </button>
                <button class="action-btn btn-success" id="new-prescription-btn" onclick="showNewPrescriptionModal()">
                    <i class="fas fa-plus-circle"></i> Create New Prescription
                </button>
                <button class="action-btn btn-warning" onclick="printPatientCard()">
                    <i class="fas fa-print"></i> Print Medical Card
                </button>
            </div>
            
            <!-- Emergency Contact Info - New Section -->
            <div class="info-section" style="margin-top: 20px; display: none;" id="emergency-contact-section">
                <div class="section-title">
                    <i class="fas fa-phone-alt" style="color: #f39c12;"></i>
                    <h3>Emergency Contact</h3>
                </div>
                <div class="info-card card-warning">
                    <div class="card-title">
                        <i class="fas fa-phone-volume"></i> Emergency Contact Number
                    </div>
                    <div class="card-content" id="emergency-contact-number">0555555501</div>
                    <div class="card-subtitle">Contact immediately in case of emergency</div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS - ENHANCED -->
    <!-- Prescription History Modal -->
    <div id="prescription-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-prescription"></i> Prescription History & Timeline</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-prescriptions" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                <!-- Filled by JavaScript -->
            </div>
        </div>
    </div>

    <!-- New Prescription Modal -->
    <div id="new-prescription-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> New Prescription</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="prescription-form">
                <div id="drugs-container">
                    <!-- Drug items will be added here -->
                </div>
                
                <button class="add-drug-btn" onclick="addDrugForm()">
                    <i class="fas fa-plus"></i> Add Another Medication
                </button>
                
                <div id="conflict-warnings" style="display: none; margin-bottom: 25px;"></div>
                <div id="conflict-errors" style="display: none; margin-bottom: 25px;"></div>
                
                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button class="load-btn" style="background: linear-gradient(45deg, #2ecc71, #27ae60); flex: 1;" onclick="checkPrescriptionConflicts()">
                        <i class="fas fa-shield-alt"></i> Check for Conflicts
                    </button>
                    <button class="load-btn" id="submit-prescription-btn" style="background: linear-gradient(45deg, #3498db, #2980b9); flex: 1;" onclick="submitPrescription()" disabled>
                        <i class="fas fa-paper-plane"></i> Submit Prescription
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prescription Confirmation Modal -->
    <div id="confirmation-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2><i class="fas fa-check-circle"></i> Confirm Prescription</h2>
                <button class="close-btn" onclick="closeConfirmationModal()">&times;</button>
            </div>
            <div style="padding: 35px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <i class="fas fa-prescription" style="font-size: 70px; color: #3498db; margin-bottom: 25px;"></i>
                    <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 24px; font-weight: 800;" id="confirmation-title">Submit Prescription?</h3>
                    <p style="color: #5a6268; font-size: 16px;" id="confirmation-message">Are you sure you want to submit this prescription?</p>
                </div>
                <div id="confirmation-warnings" style="margin-bottom: 30px; display: none;"></div>
                <div style="display: flex; gap: 20px;">
                    <button class="load-btn" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); flex: 1;" onclick="closeConfirmationModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="load-btn" style="background: linear-gradient(45deg, #2ecc71, #27ae60); flex: 1;" onclick="confirmPrescriptionSubmission()">
                        <i class="fas fa-check"></i> Confirm & Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript - Enhanced with better error handling -->
    <script>
        // Global variables
        let currentPatient = null;
        let prescriptionDrugs = [];
        let userRole = '';
        let canSubmitPrescription = false;
        let drugFormsData = {};
        let lastConflictResult = null;
        
        // Check login on load
        window.onload = function() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = '/login';
            } else {
                const userData = JSON.parse(user);
                document.getElementById('user-name').textContent = userData.name;
                document.getElementById('user-role').textContent = userData.role.charAt(0).toUpperCase() + userData.role.slice(1);
                document.getElementById('user-avatar').textContent = userData.avatar;
                document.getElementById('user-avatar').style.setProperty('--avatar-color', userData.avatar_color);
                
                userRole = userData.role;
                
                // Role-based UI adjustments
                adjustUIForRole(userData.role);
                
                // Focus on RFID input
                const rfidInput = document.getElementById('rfid-input');
                rfidInput.focus();
                setTimeout(() => {
                    rfidInput.classList.add('focus-animation');
                }, 100);
            }
            
            // Load drug list for autocomplete
            loadDrugList();
            
            // Add keyboard shortcuts
            setupKeyboardShortcuts();
        };
        
        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter to submit prescription
                if (e.ctrlKey && e.key === 'Enter') {
                    const activeModal = Array.from(document.querySelectorAll('.modal')).find(m => 
                        m.style.display === 'flex'
                    );
                    if (activeModal && activeModal.id === 'new-prescription-modal' && canSubmitPrescription) {
                        submitPrescription();
                    }
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    closeModal();
                    closeConfirmationModal();
                    closeAlert();
                }
                
                // F1 for help
                if (e.key === 'F1') {
                    e.preventDefault();
                    showAlert('info', 'Keyboard Shortcuts', 
                        'Ctrl+Enter: Submit prescription\nEsc: Close modals\nF1: This help\nTab: Navigate fields');
                }
                
                // Focus on manual input when typing starts
                if (!e.ctrlKey && !e.altKey && !e.metaKey && 
                    e.key.length === 1 && 
                    !document.getElementById('dashboard-section').style.display === 'block') {
                    const rfidInput = document.getElementById('rfid-input');
                    if (document.activeElement !== rfidInput && document.activeElement !== document.getElementById('manual-input')) {
                        rfidInput.focus();
                    }
                }
            });
        }
        
        // Adjust UI based on user role
        function adjustUIForRole(role) {
            const emergencyBtn = document.getElementById('emergency-btn');
            const newPrescriptionBtn = document.getElementById('new-prescription-btn');
            const dashboard = document.getElementById('dashboard-section');
            
            if (role === 'pharmacist') {
                // Hide emergency mode button
                if (emergencyBtn) emergencyBtn.style.display = 'none';
                // Hide new prescription button
                if (newPrescriptionBtn) newPrescriptionBtn.style.display = 'none';
                // Add pharmacist focus class
                if (dashboard) dashboard.classList.add('pharmacist-focus');
            } else if (role === 'emergency') {
                // Redirect to emergency page
                window.location.href = '/emergency-page';
            }
        }
        
        // Load drug list for search
        async function loadDrugList() {
            try {
                const response = await fetch('/drug-list');
                if (response.ok) {
                    window.drugList = await response.json();
                    console.log(`Loaded ${window.drugList.length} drugs`);
                }
            } catch (error) {
                console.error('Failed to load drug list:', error);
                showAlert('warning', 'Drug List Unavailable', 
                    'Drug suggestions may not work. You can still manually enter drug names.');
            }
        }
        
        // Handle RFID input
        document.getElementById('rfid-input').addEventListener('input', function(e) {
            const value = this.value.trim().toUpperCase();
            document.getElementById('error-display').style.display = 'none';
            
            if (value.length >= 6 && /^RFID\d+$/.test(value)) {
                loadPatient(value);
            }
        });
        
        // Add enter key support for manual input
        document.getElementById('manual-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadPatientManual();
            }
        });
        
        // Load patient manually
        async function loadPatientManual() {
            const input = document.getElementById('manual-input');
            const uid = input.value.trim().toUpperCase();
            
            if (!uid) {
                showError('Please enter a Patient ID');
                input.focus();
                return;
            }
            
            if (!/^RFID\d+$/.test(uid)) {
                showError('Invalid format. Use RFID001 to RFID050');
                input.focus();
                return;
            }
            
            await loadPatient(uid);
        }
        
        // Main patient loading function
        async function loadPatient(uid) {
            try {
                // Show loading state
                const loadBtn = document.querySelector('.load-btn');
                const originalText = loadBtn.innerHTML;
                loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                loadBtn.disabled = true;
                document.getElementById('rfid-input').disabled = true;
                
                const response = await fetch(`/patient-details/${uid}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError(`Patient ${uid} not found. Valid IDs: RFID001 to RFID050`);
                    } else {
                        throw new Error('Network error');
                    }
                    loadBtn.innerHTML = originalText;
                    loadBtn.disabled = false;
                    document.getElementById('rfid-input').disabled = false;
                    return;
                }
                
                const data = await response.json();
                currentPatient = data;
                
                // Show dashboard, hide scanner
                document.getElementById('lookup-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('home-btn').style.display = 'block';
                document.getElementById('emergency-btn').style.display = 'none';
                
                // Update patient info
                updatePatientDashboard(data);
                
                // Clear inputs
                document.getElementById('rfid-input').value = '';
                document.getElementById('manual-input').value = '';
                document.getElementById('rfid-input').disabled = false;
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
                
                // Show success message
                showAlert('success', 'Patient Loaded', 
                    `Successfully loaded ${data.first_name} ${data.last_name}`, 3000);
                
            } catch (error) {
                console.error('Error loading patient:', error);
                showError(error.message || 'Failed to load patient data');
                const loadBtn = document.querySelector('.load-btn');
                loadBtn.innerHTML = '<i class="fas fa-search"></i> Load Patient';
                loadBtn.disabled = false;
                document.getElementById('rfid-input').disabled = false;
            }
        }
        
        // Update dashboard with patient data
        function updatePatientDashboard(data) {
            // Generate avatar color
            const avatarColor = generateColorFromString(data.patient_id);
            document.documentElement.style.setProperty('--patient-avatar-color', avatarColor);
            
            // Basic info
            document.getElementById('patient-name').textContent = `${data.first_name} ${data.last_name}`;
            document.getElementById('patient-avatar').textContent = data.first_name.charAt(0);
            document.getElementById('patient-id').textContent = data.patient_id;
            document.getElementById('patient-age-sex').textContent = `${data.age} years ‚Ä¢ ${data.sex === 'M' ? 'Male' : 'Female'}`;
            document.getElementById('patient-dob').textContent = data.date_of_birth;
            document.getElementById('patient-blood').textContent = data.blood_type || 'Unknown';
            document.getElementById('last-visit').textContent = data.last_visit_date || 'No visits';
            document.getElementById('last-visit-notes').textContent = data.last_visit_notes || 'No notes available';
            
            // Health score
            const healthScore = data.health_score || 0;
            document.getElementById('health-score').textContent = healthScore;
            updateHealthBars(healthScore);
            
            // Update health score color based on value
            const healthScoreElement = document.getElementById('health-score');
            if (healthScore >= 80) {
                healthScoreElement.style.color = '#2ecc71';
            } else if (healthScore >= 60) {
                healthScoreElement.style.color = '#f39c12';
            } else {
                healthScoreElement.style.color = '#e74c3c';
            }
            
            // Allergies with critical highlighting
            const allergiesContainer = document.getElementById('allergies-container');
            if (data.allergies && data.allergies.length > 0) {
                const severeAllergies = data.allergies.filter(a => a.severity === 'Severe');
                const otherAllergies = data.allergies.filter(a => a.severity !== 'Severe');
                
                let html = '';
                
                // Show severe allergies first
                if (severeAllergies.length > 0) {
                    severeAllergies.forEach(allergy => {
                        html += `
                            <div class="info-card card-critical">
                                <div class="card-title">
                                    <i class="fas fa-exclamation-circle"></i> ${allergy.name}
                                </div>
                                <div class="card-content">${allergy.severity}</div>
                                <div class="card-subtitle">‚ö†Ô∏è Requires immediate attention</div>
                            </div>
                        `;
                    });
                }
                
                // Show other allergies
                if (otherAllergies.length > 0) {
                    otherAllergies.forEach(allergy => {
                        const isModerate = allergy.severity === 'Moderate';
                        html += `
                            <div class="info-card ${isModerate ? 'card-warning' : ''}">
                                <div class="card-title">
                                    <i class="fas fa-exclamation-triangle"></i> ${allergy.name}
                                </div>
                                <div class="card-content">${allergy.severity}</div>
                                <div class="card-subtitle">${isModerate ? 'Monitor carefully' : 'Mild sensitivity'}</div>
                            </div>
                        `;
                    });
                }
                
                allergiesContainer.innerHTML = html;
            } else {
                allergiesContainer.innerHTML = `
                    <div class="info-card card-success">
                        <div class="card-title">
                            <i class="fas fa-check-circle"></i> No Known Allergies
                        </div>
                        <div class="card-content">‚úì Clear</div>
                        <div class="card-subtitle">No allergy records found</div>
                    </div>
                `;
            }
            
            // Diseases
            const diseasesContainer = document.getElementById('diseases-container');
            if (data.chronic_diseases && data.chronic_diseases.length > 0) {
                diseasesContainer.innerHTML = data.chronic_diseases.map(disease => `
                    <div class="info-card">
                        <div class="card-title">
                            <i class="fas fa-user-md"></i> ${disease}
                        </div>
                        <div class="card-content">Chronic Condition</div>
                        <div class="card-subtitle">Requires ongoing management</div>
                    </div>
                `).join('');
            } else {
                diseasesContainer.innerHTML = `
                    <div class="info-card card-success">
                        <div class="card-title">
                            <i class="fas fa-heart"></i> No Chronic Conditions
                        </div>
                        <div class="card-content">‚úì Healthy</div>
                        <div class="card-subtitle">No chronic disease records</div>
                    </div>
                `;
            }
            
            // Prescriptions - Enhanced for pharmacist focus
            const prescriptionsContainer = document.getElementById('prescriptions-container');
            if (data.prescriptions && data.prescriptions.length > 0) {
                if (userRole === 'pharmacist') {
                    // For pharmacists, show more detailed prescription info
                    prescriptionsContainer.innerHTML = `
                        <div class="grid-3">
                            ${data.prescriptions.map(p => `
                                <div class="info-card card-primary">
                                    <div class="card-title">
                                        <i class="fas fa-pills"></i> ${p.drug_name || 'Unknown Drug'}
                                    </div>
                                    <div class="card-content">${p.dosage || 'Not specified'}</div>
                                    <div class="card-subtitle">
                                        <div><i class="fas fa-clock"></i> ${p.frequency || 'Not specified'}</div>
                                        <div><i class="fas fa-calendar"></i> ${p.duration || 'Not specified'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center; margin-top: 25px; padding: 15px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 12px; color: #3498db; font-weight: 700;">
                            <i class="fas fa-info-circle"></i> ${data.prescriptions.length} active prescription(s) found
                        </div>
                    `;
                } else {
                    prescriptionsContainer.innerHTML = `
                        <div class="grid-3">
                            ${data.prescriptions.map(p => `
                                <div class="info-card">
                                    <div class="card-title">
                                        <i class="fas fa-pills"></i> ${p.drug_name || 'Unknown Drug'}
                                    </div>
                                    <div class="card-content">${p.dosage || 'Not specified'}</div>
                                    <div class="card-subtitle">
                                        <div><i class="fas fa-clock"></i> ${p.frequency || 'Not specified'}</div>
                                        <div><i class="fas fa-calendar"></i> Duration: ${p.duration || 'Not specified'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else {
                prescriptionsContainer.innerHTML = `
                    <div class="info-card card-success">
                        <div class="card-title">
                            <i class="fas fa-prescription"></i> No Active Prescriptions
                        </div>
                        <div class="card-content">‚úì None</div>
                        <div class="card-subtitle">Patient has no current medications</div>
                    </div>
                `;
            }
            
            // Show emergency contact if available
            if (data.emergency_contact) {
                document.getElementById('emergency-contact-section').style.display = 'block';
                document.getElementById('emergency-contact-number').textContent = data.emergency_contact;
            }
        }
        
        // Update health bars (without animation)
        function updateHealthBars(score) {
            const barsContainer = document.getElementById('health-bars');
            barsContainer.innerHTML = '';
            
            const barCount = 10;
            const activeBars = Math.ceil(score / 10);
            
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'health-bar';
                if (i < activeBars) {
                    bar.classList.add('active');
                }
                barsContainer.appendChild(bar);
            }
        }
        
        // Generate color from string
        function generateColorFromString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#27ae60', '#8e44ad'
            ];
            return colors[Math.abs(hash) % colors.length];
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-exclamation-circle fa-lg"></i>
                    <div style="font-weight: 700;">${message}</div>
                </div>
            `;
            errorDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (errorDiv.style.display === 'block') {
                    errorDiv.style.display = 'none';
                }
            }, 5000);
        }
        
        // Show custom alert
        function showAlert(type, title, message, duration = 5000) {
            const alertDiv = document.getElementById('custom-alert');
            const alertIcon = document.getElementById('alert-icon');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            
            // Set alert type
            alertDiv.className = 'custom-alert';
            alertDiv.classList.add(`alert-${type}`);
            
            // Set icon based on type
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-times-circle';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            
            alertIcon.innerHTML = `<i class="${iconClass}"></i>`;
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            
            // Show alert
            alertDiv.style.display = 'flex';
            alertDiv.style.animation = 'none';
            setTimeout(() => {
                alertDiv.style.animation = 'slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }, 10);
            
            // Auto-hide after duration
            if (duration > 0) {
                setTimeout(() => {
                    closeAlert();
                }, duration);
            }
        }
        
        // Close alert
        function closeAlert() {
            const alertDiv = document.getElementById('custom-alert');
            alertDiv.style.animation = 'none';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10);
        }
        
        // Back to lookup
        function backToLookup() {
            document.getElementById('lookup-section').style.display = 'block';
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('home-btn').style.display = 'none';
            document.getElementById('emergency-btn').style.display = 'block';
            document.getElementById('rfid-input').value = '';
            document.getElementById('manual-input').value = '';
            document.getElementById('error-display').style.display = 'none';
            document.getElementById('rfid-input').focus();
            
            // Show alert
            showAlert('info', 'Ready to Scan', 'Enter another Patient ID or scan RFID card', 3000);
        }
        
        // Back to home
        function backToHome() {
            backToLookup();
        }
        
        // Show prescription modal with history and timeline
        async function showPrescriptionModal() {
            if (userRole === 'emergency') {
                showAlert('warning', 'Access Restricted', 'Emergency mode can only view basic patient info.');
                return;
            }
            
            const modal = document.getElementById('prescription-modal');
            const container = document.getElementById('modal-prescriptions');
            
            // Show loading
            container.innerHTML = `
                <div style="text-align: center; padding: 60px;">
                    <i class="fas fa-spinner fa-spin fa-3x" style="color: #3498db;"></i>
                    <p style="margin-top: 25px; color: #5a6268; font-size: 16px; font-weight: 600;">Loading prescription history...</p>
                </div>
            `;
            modal.style.display = 'flex';
            
            // Load prescription history and timeline
            try {
                const response = await fetch(`/prescription-history/${currentPatient.patient_id}`);
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                
                const data = await response.json();
                const prescriptions = data.prescriptions || [];
                const timeline = data.timeline || [];
                
                if (prescriptions.length === 0 && timeline.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px;">
                            <i class="fas fa-prescription" style="font-size: 70px; color: #ddd; margin-bottom: 25px;"></i>
                            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 24px;">No Prescriptions Found</h3>
                            <p style="color: #5a6268; font-size: 16px;">This patient has no prescription history or timeline events.</p>
                        </div>
                    `;
                } else {
                    let content = `
                        <div style="margin-bottom: 35px;">
                            <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 3px solid #3498db; padding-bottom: 15px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-prescription"></i> Prescription History
                            </h3>
                    `;
                    
                    if (prescriptions.length > 0) {
                        prescriptions.forEach(rx => {
                            const isActive = rx.status === 'active';
                            content += `
                                <div style="background: ${isActive ? 'linear-gradient(135deg, #d4edda, #c3e6cb)' : '#f8f9fa'}; padding: 25px; border-radius: 16px; border-left: 6px solid ${isActive ? '#28a745' : '#6c757d'}; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.08);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center;">
                                        <div>
                                            <strong style="font-size: 18px; color: #2c3e50; font-weight: 800;">Prescription #${rx.prescription_id}</strong>
                                            <div style="font-size: 15px; color: #6c757d; margin-top: 8px; display: flex; align-items: center; gap: 10px;">
                                                <i class="far fa-calendar"></i> ${new Date(rx.date).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <span style="background: ${isActive ? '#28a745' : '#6c757d'}; color: white; padding: 6px 18px; border-radius: 25px; font-size: 13px; font-weight: 800; letter-spacing: 0.5px;">
                                            ${rx.status.toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="display: grid; gap: 15px;">
                                        ${rx.drugs.map(drug => `
                                            <div style="display: flex; justify-content: space-between; padding: 15px; background: white; border-radius: 10px; border: 1px solid #dee2e6;">
                                                <div style="font-weight: 800; color: #2c3e50; font-size: 16px;">${drug.drug_name}</div>
                                                <div style="font-size: 15px; color: #6c757d; display: flex; gap: 15px;">
                                                    <span>${drug.dosage}</span>
                                                    <span>‚Ä¢</span>
                                                    <span>${drug.frequency}</span>
                                                    <span>‚Ä¢</span>
                                                    <span>${drug.duration}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        content += `
                            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 16px; margin-bottom: 25px; border: 2px dashed #dee2e6;">
                                <i class="fas fa-prescription" style="font-size: 50px; color: #ddd; margin-bottom: 20px;"></i>
                                <p style="color: #5a6268; font-size: 16px; font-weight: 600;">No prescription history found</p>
                            </div>
                        `;
                    }
                    
                    // Add timeline section
                    content += `
                        </div>
                        <div>
                            <h3 style="color: #2c3e50; margin-bottom: 25px; border-bottom: 3px solid #3498db; padding-bottom: 15px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-history"></i> Patient Timeline
                            </h3>
                    `;
                    
                    if (timeline.length > 0) {
                        timeline.forEach(item => {
                            const iconColor = item.type === 'prescription' ? '#2ecc71' : 
                                            item.type === 'visit' ? '#3498db' : '#9b59b6';
                            
                            content += `
                                <div class="timeline-item">
                                    <div class="timeline-icon" style="background: ${iconColor};">
                                        <i class="${item.icon}"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-date">
                                            <i class="far fa-clock"></i> ${new Date(item.date).toLocaleDateString()} ${new Date(item.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                        </div>
                                        <div class="timeline-title">${item.title}</div>
                                        <div class="timeline-description">${item.description}</div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        content += `
                            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 16px; border: 2px dashed #dee2e6;">
                                <i class="fas fa-history" style="font-size: 50px; color: #ddd; margin-bottom: 20px;"></i>
                                <p style="color: #5a6268; font-size: 16px; font-weight: 600;">No timeline events found</p>
                            </div>
                        `;
                    }
                    
                    content += `</div>`;
                    container.innerHTML = content;
                }
            } catch (error) {
                console.error('Error loading prescription history:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 60px; margin-bottom: 25px;"></i>
                        <h3 style="margin-bottom: 15px; font-size: 22px;">Error Loading Prescription History</h3>
                        <p style="margin-bottom: 25px; font-size: 16px;">${error.message || 'Please try again'}</p>
                        <button class="load-btn" style="padding: 12px 30px; font-size: 16px;" onclick="showPrescriptionModal()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        // Show new prescription modal
        function showNewPrescriptionModal() {
            if (userRole === 'pharmacist') {
                showAlert('warning', 'Access Restricted', 'Pharmacists can only view prescriptions, not create them.');
                return;
            }
            
            if (userRole === 'emergency') {
                showAlert('warning', 'Access Restricted', 'Emergency mode can only view patient info.');
                return;
            }
            
            const modal = document.getElementById('new-prescription-modal');
            prescriptionDrugs = [];
            canSubmitPrescription = false;
            drugFormsData = {};
            lastConflictResult = null;
            
            // Clear container and add first drug form
            document.getElementById('drugs-container').innerHTML = '';
            addDrugForm();
            
            // Clear warnings and errors
            document.getElementById('conflict-warnings').innerHTML = '';
            document.getElementById('conflict-warnings').style.display = 'none';
            document.getElementById('conflict-errors').innerHTML = '';
            document.getElementById('conflict-errors').style.display = 'none';
            
            // Disable submit button
            document.getElementById('submit-prescription-btn').disabled = true;
            
            modal.style.display = 'flex';
        }
        
        // Add drug form (preserves data)
        function addDrugForm() {
            const container = document.getElementById('drugs-container');
            const drugId = Date.now() + Math.random();
            const drugCount = Object.keys(drugFormsData).length;
            
            // Get stored data for this position if it exists
            const storedData = drugFormsData[drugCount] || {};
            
            const drugForm = `
                <div class="drug-item" id="drug-${drugId}" data-index="${drugCount}">
                    <div class="drug-header">
                        <h4>Medication #${drugCount + 1}</h4>
                        ${drugCount > 0 ? `
                            <button class="remove-drug" onclick="removeDrug('${drugId}')">&times;</button>
                        ` : ''}
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-pills"></i> Drug Name *</label>
                            <input type="text" class="drug-name" placeholder="Search drug..." 
                                   value="${storedData.name || ''}"
                                   oninput="searchDrugs(this)" list="drug-suggestions-${drugId}"
                                   onchange="saveDrugData('${drugId}')">
                            <datalist id="drug-suggestions-${drugId}"></datalist>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-weight"></i> Dosage *</label>
                            <input type="text" class="drug-dosage" placeholder="e.g., 500mg" 
                                   value="${storedData.dosage || ''}"
                                   oninput="saveDrugData('${drugId}')">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-clock"></i> Frequency *</label>
                            <select class="drug-frequency" onchange="saveDrugData('${drugId}')">
                                <option value="">Select frequency</option>
                                <option value="Once daily" ${storedData.frequency === 'Once daily' ? 'selected' : ''}>Once daily</option>
                                <option value="Twice daily" ${storedData.frequency === 'Twice daily' ? 'selected' : ''}>Twice daily</option>
                                <option value="Three times daily" ${storedData.frequency === 'Three times daily' ? 'selected' : ''}>Three times daily</option>
                                <option value="Four times daily" ${storedData.frequency === 'Four times daily' ? 'selected' : ''}>Four times daily</option>
                                <option value="Every 6 hours" ${storedData.frequency === 'Every 6 hours' ? 'selected' : ''}>Every 6 hours</option>
                                <option value="Every 8 hours" ${storedData.frequency === 'Every 8 hours' ? 'selected' : ''}>Every 8 hours</option>
                                <option value="Every 12 hours" ${storedData.frequency === 'Every 12 hours' ? 'selected' : ''}>Every 12 hours</option>
                                <option value="As needed" ${storedData.frequency === 'As needed' ? 'selected' : ''}>As needed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Duration *</label>
                            <input type="text" class="drug-duration" placeholder="e.g., 7 days, 2 weeks" 
                                   value="${storedData.duration || ''}"
                                   oninput="saveDrugData('${drugId}')">
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += drugForm;
            
            // Initialize drug search
            const drugNameInput = document.getElementById(`drug-${drugId}`).querySelector('.drug-name');
            if (drugNameInput.value) {
                searchDrugs(drugNameInput);
            }
        }
        
        // Save drug data to preserve it
        function saveDrugData(drugId) {
            const drugElement = document.getElementById(`drug-${drugId}`);
            if (!drugElement) return;
            
            const index = parseInt(drugElement.dataset.index);
            drugFormsData[index] = {
                name: drugElement.querySelector('.drug-name').value,
                dosage: drugElement.querySelector('.drug-dosage').value,
                frequency: drugElement.querySelector('.drug-frequency').value,
                duration: drugElement.querySelector('.drug-duration').value
            };
        }
        
        // Remove drug form
        function removeDrug(drugId) {
            const element = document.getElementById(`drug-${drugId}`);
            if (element) {
                const index = parseInt(element.dataset.index);
                
                // Remove this drug's data
                delete drugFormsData[index];
                
                // Shift all higher indices down
                const newData = {};
                Object.keys(drugFormsData).forEach(key => {
                    const numKey = parseInt(key);
                    if (numKey > index) {
                        newData[numKey - 1] = drugFormsData[key];
                    } else if (numKey < index) {
                        newData[numKey] = drugFormsData[key];
                    }
                });
                
                drugFormsData = newData;
                element.remove();
                
                // Renumber remaining drugs
                const container = document.getElementById('drugs-container');
                const drugItems = container.querySelectorAll('.drug-item');
                drugItems.forEach((item, idx) => {
                    const header = item.querySelector('h4');
                    header.textContent = `Medication #${idx + 1}`;
                    item.dataset.index = idx;
                });
            }
        }
        
        // Search drugs
        function searchDrugs(inputElement) {
            const searchTerm = inputElement.value.toLowerCase();
            if (searchTerm.length < 2) return;
            
            if (!window.drugList || window.drugList.length === 0) return;
            
            // Get the drug form ID
            const drugItem = inputElement.closest('.drug-item');
            const drugId = drugItem.id.replace('drug-', '');
            
            // Filter drugs
            const filteredDrugs = window.drugList.filter(drug => 
                drug.drug_name.toLowerCase().includes(searchTerm)
            ).slice(0, 10);
            
            // Update datalist
            const datalist = document.getElementById(`drug-suggestions-${drugId}`);
            datalist.innerHTML = filteredDrugs.map(drug => 
                `<option value="${drug.drug_name}">${drug.drug_name} - ${drug.description}</option>`
            ).join('');
        }
        
        // Check prescription conflicts
        async function checkPrescriptionConflicts() {
            // Collect drug data from all forms
            const drugItems = document.querySelectorAll('.drug-item');
            const drugs = [];
            
            for (const item of drugItems) {
                const name = item.querySelector('.drug-name').value.trim();
                const dosage = item.querySelector('.drug-dosage').value.trim();
                const frequency = item.querySelector('.drug-frequency').value;
                const duration = item.querySelector('.drug-duration').value.trim();
                
                if (name && dosage && frequency && duration) {
                    drugs.push({ name, dosage, frequency, duration });
                } else {
                    showAlert('warning', 'Incomplete Information', 'Please fill all fields for each medication.');
                    return;
                }
            }
            
            if (drugs.length === 0) {
                showAlert('warning', 'No Medications', 'Please add at least one medication.');
                return;
            }
            
            // Get patient allergies and diseases
            const allergies = currentPatient.allergies.map(a => a.name);
            const diseases = currentPatient.chronic_diseases;
            const existingDrugs = currentPatient.prescriptions.map(p => p.drug_name);
            
            try {
                // Check conflicts
                const response = await fetch('/check-prescription-conflicts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        drugs: drugs,
                        allergies: allergies,
                        diseases: diseases,
                        existing_drugs: existingDrugs
                    })
                });
                
                const result = await response.json();
                lastConflictResult = result;
                
                // Display warnings and errors
                const warningsDiv = document.getElementById('conflict-warnings');
                const errorsDiv = document.getElementById('conflict-errors');
                
                warningsDiv.innerHTML = '';
                errorsDiv.innerHTML = '';
                
                if (result.errors && result.errors.length > 0) {
                    errorsDiv.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 25px; border-radius: 16px; border: 3px solid #dc3545; box-shadow: 0 10px 30px rgba(220, 53, 69, 0.15);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <i class="fas fa-times-circle" style="font-size: 28px;"></i>
                                <strong style="font-size: 20px;">CRITICAL CONFLICTS DETECTED</strong>
                            </div>
                            <div style="background: #f5c6cb; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <strong>Prescription cannot be submitted until these conflicts are resolved:</strong>
                            </div>
                            <ul style="margin: 15px 0; padding-left: 20px;">
                                ${result.errors.map(e => `<li style="margin-bottom: 12px; padding: 12px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">‚ùå ${e}</li>`).join('')}
                            </ul>
                            <div style="background: #dc3545; color: white; padding: 15px; border-radius: 10px; text-align: center; font-weight: 800; margin-top: 20px; font-size: 16px;">
                                <i class="fas fa-ban"></i> PRESCRIPTION BLOCKED - RESOLVE CONFLICTS FIRST
                            </div>
                        </div>
                    `;
                    errorsDiv.style.display = 'block';
                    canSubmitPrescription = false;
                }
                
                if (result.warnings && result.warnings.length > 0) {
                    warningsDiv.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 25px; border-radius: 16px; border: 3px solid #ffc107; box-shadow: 0 10px 30px rgba(255, 193, 7, 0.15);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 28px;"></i>
                                <strong style="font-size: 20px;">WARNINGS</strong>
                            </div>
                            <ul style="margin: 15px 0; padding-left: 20px;">
                                ${result.warnings.map(w => `<li style="margin-bottom: 12px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">‚ö†Ô∏è ${w}</li>`).join('')}
                            </ul>
                            <div style="background: #ffc107; color: #856404; padding: 15px; border-radius: 10px; text-align: center; font-weight: 800; margin-top: 20px; font-size: 16px;">
                                <i class="fas fa-info-circle"></i> Review these warnings before proceeding
                            </div>
                        </div>
                    `;
                    warningsDiv.style.display = 'block';
                }
                
                if (result.can_submit && result.errors.length === 0) {
                    warningsDiv.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 25px; border-radius: 16px; border: 3px solid #28a745; box-shadow: 0 10px 30px rgba(40, 167, 69, 0.15);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 28px;"></i>
                                <strong style="font-size: 20px;">NO CONFLICTS DETECTED</strong>
                            </div>
                            <p style="margin-top: 15px; font-size: 16px; line-height: 1.6;">
                                All medications are safe for this patient. You may proceed with submission.
                            </p>
                            <div style="background: #28a745; color: white; padding: 15px; border-radius: 10px; text-align: center; font-weight: 800; margin-top: 20px; font-size: 16px;">
                                <i class="fas fa-check"></i> READY TO SUBMIT - NO CRITICAL CONFLICTS
                            </div>
                        </div>
                    `;
                    warningsDiv.style.display = 'block';
                    canSubmitPrescription = true;
                }
                
                // Enable/disable submit button
                document.getElementById('submit-prescription-btn').disabled = !canSubmitPrescription;
                
                // Store drugs for submission
                prescriptionDrugs = drugs;
                
                // Show success message if no conflicts
                if (result.can_submit) {
                    showAlert('success', 'No Conflicts', 'All medications are safe for this patient. You may submit the prescription.');
                }
                
            } catch (error) {
                console.error('Error checking conflicts:', error);
                showAlert('error', 'Network Error', 'Failed to check conflicts. Please try again.');
            }
        }
        
        // Submit prescription with enhanced confirmation
        async function submitPrescription() {
            // First, check for conflicts if not already checked
            if (!lastConflictResult) {
                await checkPrescriptionConflicts();
                if (!canSubmitPrescription) {
                    showAlert('warning', 'Check Conflicts First', 'Please check for conflicts before submitting.');
                    return;
                }
            }
            
            // If there are errors (critical conflicts), do not proceed
            if (lastConflictResult.errors && lastConflictResult.errors.length > 0) {
                showAlert('error', 'Critical Conflicts', 'Cannot submit prescription with critical conflicts.');
                return;
            }
            
            if (prescriptionDrugs.length === 0) {
                showAlert('warning', 'No Medications', 'Please add medications first.');
                return;
            }
            
            // Show enhanced confirmation modal
            showConfirmationModal();
        }
        
        // Show confirmation modal
        function showConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            const title = document.getElementById('confirmation-title');
            const message = document.getElementById('confirmation-message');
            const warningsDiv = document.getElementById('confirmation-warnings');
            
            title.textContent = `Submit ${prescriptionDrugs.length} Medication(s)?`;
            message.textContent = `Are you sure you want to submit this prescription for ${currentPatient.first_name} ${currentPatient.last_name}?`;
            
            if (lastConflictResult && lastConflictResult.warnings && lastConflictResult.warnings.length > 0) {
                warningsDiv.innerHTML = `
                    <div style="background: #fff3cd; color: #856404; padding: 20px; border-radius: 12px; border: 2px solid #ffc107;">
                        <strong style="display: flex; align-items: center; gap: 10px; font-size: 16px;">
                            <i class="fas fa-exclamation-triangle"></i> Warnings:
                        </strong>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            ${lastConflictResult.warnings.map(w => `<li style="margin-bottom: 8px; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 6px;">${w}</li>`).join('')}
                        </ul>
                    </div>
                `;
                warningsDiv.style.display = 'block';
            } else {
                warningsDiv.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }
        
        // Close confirmation modal
        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }
        
        // Confirm prescription submission
        async function confirmPrescriptionSubmission() {
            closeConfirmationModal();
            
            // Show loading state
            const submitBtn = document.getElementById('submit-prescription-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/add-prescription', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        patient_id: currentPatient.patient_id,
                        drugs: prescriptionDrugs
                    })
                });
                
                const result = await response.json();
                
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (result.success) {
                    showAlert('success', 'Prescription Submitted', 
                        `Prescription #${result.prescription_id} has been successfully submitted for ${currentPatient.first_name} ${currentPatient.last_name}!`, 
                        5000);
                    closeModal();
                    // Refresh patient data
                    await loadPatient(currentPatient.patient_id);
                } else {
                    if (result.type === 'conflict') {
                        showAlert('error', 'Critical Conflicts', 
                            'Prescription blocked due to critical conflicts. Please review and adjust medications.');
                        // Re-check conflicts to show them
                        await checkPrescriptionConflicts();
                    } else {
                        showAlert('error', 'Submission Failed', 
                            result.error || 'Failed to submit prescription. Please try again.');
                    }
                }
                
            } catch (error) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showAlert('error', 'Network Error', 
                    'Failed to submit prescription. Please check your connection and try again.');
            }
        }
        
        // Print patient card
        function printPatientCard() {
            if (!currentPatient) {
                showAlert('warning', 'No Patient Selected', 'Please load a patient first.');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const now = new Date();
            const timestamp = now.toLocaleString();
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Medical Card - ${currentPatient.first_name} ${currentPatient.last_name}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                            background: #f8f9fa; 
                            padding: 40px; 
                            display: flex; 
                            justify-content: center; 
                            align-items: center; 
                            min-height: 100vh;
                        }
                        .medical-card { 
                            background: white; 
                            border: 4px solid #3498db; 
                            border-radius: 25px; 
                            padding: 40px; 
                            max-width: 550px; 
                            width: 100%; 
                            box-shadow: 0 20px 50px rgba(52, 152, 219, 0.2);
                            position: relative;
                            overflow: hidden;
                        }
                        .medical-card::before {
                            content: 'üè• MEDICAL IDENTIFICATION üè•';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            background: linear-gradient(45deg, #3498db, #2ecc71);
                            color: white;
                            text-align: center;
                            padding: 15px;
                            font-weight: 900;
                            font-size: 16px;
                            letter-spacing: 1.5px;
                        }
                        .header { 
                            text-align: center; 
                            margin: 60px 0 40px 0; 
                        }
                        .header h1 { 
                            color: #3498db; 
                            margin-bottom: 15px; 
                            font-size: 32px;
                            font-weight: 900;
                            letter-spacing: -0.5px;
                        }
                        .header p { 
                            color: #7f8c8d; 
                            font-size: 14px;
                            font-weight: 600;
                        }
                        .qr-section { 
                            text-align: center; 
                            margin: 30px 0; 
                            padding: 25px; 
                            background: #f8f9fa; 
                            border-radius: 20px; 
                            border: 3px dashed #3498db;
                        }
                        .qr-code {
                            background: white;
                            padding: 20px;
                            display: inline-block;
                            border-radius: 15px;
                            margin-bottom: 15px;
                            font-size: 24px;
                            font-weight: 900;
                            color: #3498db;
                            border: 2px solid #3498db;
                        }
                        .patient-info {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 25px;
                            margin: 30px 0;
                        }
                        .info-item {
                            padding: 20px;
                            border-radius: 15px;
                            background: linear-gradient(135deg, #f8f9fa, #ffffff);
                            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
                        }
                        .info-label {
                            font-size: 13px;
                            color: #7f8c8d;
                            margin-bottom: 8px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-weight: 800;
                        }
                        .info-value {
                            font-size: 24px;
                            font-weight: 900;
                            color: #2c3e50;
                        }
                        .critical-info {
                            background: linear-gradient(135deg, #ffeaea, #ffcccc);
                            border: 2px solid #e74c3c;
                        }
                        .critical-info .info-value {
                            color: #e74c3c;
                            font-size: 32px;
                        }
                        .section { 
                            margin: 30px 0; 
                            padding: 25px; 
                            border: 2px solid; 
                            border-radius: 20px; 
                            background: linear-gradient(135deg, #ffffff, #f8f9fa);
                            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
                        }
                        .section-title { 
                            font-weight: 900; 
                            font-size: 18px;
                            margin-bottom: 20px; 
                            padding-bottom: 15px; 
                            border-bottom: 3px solid; 
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        }
                        .allergy-section { 
                            border-color: #e74c3c; 
                            background: linear-gradient(135deg, #ffeaea, #ffcccc);
                        }
                        .allergy-section .section-title { 
                            color: #e74c3c; 
                            border-color: #e74c3c; 
                        }
                        .condition-section { 
                            border-color: #3498db; 
                            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                        }
                        .condition-section .section-title { 
                            color: #3498db; 
                            border-color: #3498db; 
                        }
                        .medication-section { 
                            border-color: #2ecc71; 
                            background: linear-gradient(135deg, #d4edda, #c3e6cb);
                        }
                        .medication-section .section-title { 
                            color: #2ecc71; 
                            border-color: #2ecc71; 
                        }
                        .contact-section {
                            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
                            border-color: #f39c12;
                            text-align: center;
                            margin: 40px 0;
                        }
                        .contact-section .section-title {
                            color: #f39c12;
                            border-color: #f39c12;
                            justify-content: center;
                        }
                        .contact-number {
                            font-size: 32px;
                            font-weight: 900;
                            color: #2c3e50;
                            margin: 20px 0;
                            letter-spacing: 1px;
                        }
                        .footer {
                            margin-top: 50px;
                            text-align: center;
                            color: #95a5a6;
                            font-size: 13px;
                            border-top: 2px solid #eee;
                            padding-top: 25px;
                            font-weight: 600;
                        }
                        @media print {
                            body { padding: 0; background: white; }
                            .medical-card { 
                                border: 3px solid #3498db; 
                                box-shadow: none; 
                                max-width: 100%;
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="medical-card">
                        <div class="header">
                            <h1>Medical Identification Card</h1>
                            <p>In case of emergency, present this card to medical personnel</p>
                        </div>
                        
                        <div class="qr-section">
                            <div class="qr-code">${currentPatient.patient_id}</div>
                            <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 10px;">PATIENT QR CODE</div>
                            <div style="font-size: 12px; color: #95a5a6;">Scan for complete medical history</div>
                        </div>
                        
                        <div class="patient-info">
                            <div class="info-item">
                                <div class="info-label">Patient Name</div>
                                <div class="info-value">${currentPatient.first_name} ${currentPatient.last_name}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Patient ID</div>
                                <div class="info-value" style="color: #3498db;">${currentPatient.patient_id}</div>
                            </div>
                            <div class="info-item critical-info">
                                <div class="info-label">Blood Type</div>
                                <div class="info-value">${currentPatient.blood_type || 'Unknown'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date of Birth</div>
                                <div class="info-value">${currentPatient.date_of_birth}</div>
                            </div>
                        </div>
                        
                        ${currentPatient.allergies && currentPatient.allergies.length > 0 ? `
                            <div class="allergy-section">
                                <div class="section-title"><i class="fas fa-exclamation-triangle"></i> ALLERGIES & SENSITIVITIES</div>
                                ${currentPatient.allergies.map(a => `
                                    <div style="margin: 15px 0; padding: 15px; background: ${a.severity === 'Severe' ? 'linear-gradient(135deg, #ffcccc, #ff9999)' : 'linear-gradient(135deg, #fff3cd, #ffeaa7)'}; border-radius: 12px; border-left: 4px solid ${a.severity === 'Severe' ? '#e74c3c' : '#f39c12'};">
                                        <div style="font-weight: 900; color: #2c3e50; font-size: 18px;">${a.name}</div>
                                        <div style="color: ${a.severity === 'Severe' ? '#e74c3c' : '#f39c12'}; font-weight: 800; margin-top: 5px;">
                                            <i class="fas fa-exclamation-circle"></i> ${a.severity.toUpperCase()}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${currentPatient.chronic_diseases && currentPatient.chronic_diseases.length > 0 ? `
                            <div class="condition-section">
                                <div class="section-title"><i class="fas fa-stethoscope"></i> CHRONIC CONDITIONS</div>
                                ${currentPatient.chronic_diseases.map(d => `
                                    <div style="margin: 12px 0; padding: 12px; background: white; border-radius: 10px; border: 1px solid #e3f2fd;">
                                        <div style="font-weight: 800; color: #2c3e50;">${d}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${currentPatient.prescriptions && currentPatient.prescriptions.length > 0 ? `
                            <div class="medication-section">
                                <div class="section-title"><i class="fas fa-pills"></i> CURRENT MEDICATIONS</div>
                                ${currentPatient.prescriptions.map(p => `
                                    <div style="margin: 12px 0; padding: 12px; background: white; border-radius: 10px; border: 1px solid #d4edda;">
                                        <div style="font-weight: 800; color: #2c3e50;">${p.drug_name || 'Unknown'}</div>
                                        <div style="color: #5a6268; margin-top: 5px; font-size: 14px;">
                                            <strong>Dosage:</strong> ${p.dosage || 'Not specified'} | 
                                            <strong>Frequency:</strong> ${p.frequency || 'Not specified'} | 
                                            <strong>Duration:</strong> ${p.duration || 'Not specified'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${currentPatient.emergency_contact ? `
                            <div class="contact-section">
                                <div class="section-title"><i class="fas fa-phone-alt"></i> EMERGENCY CONTACT</div>
                                <div class="contact-number">${currentPatient.emergency_contact}</div>
                                <div style="color: #5a6268; font-size: 14px; font-weight: 600;">Call immediately in case of emergency</div>
                            </div>
                        ` : ''}
                        
                        <div class="footer">
                            <div style="font-weight: 900; color: #2c3e50; margin-bottom: 5px; font-size: 14px;">Generated by Smart RFID Medical System</div>
                            <div>${timestamp}</div>
                            <div style="margin-top: 15px; font-size: 11px; color: #bdc3c7; font-weight: 600;">This document contains sensitive medical information - Handle with care</div>
                        </div>
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(() => window.close(), 1000);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Close modal
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/logout';
        }
    </script>
</body>
</html>